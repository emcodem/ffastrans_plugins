<!DOCTYPE html>
<meta http-equiv="X-UA-Compatible" content="IE=11" /> 
<head>
<link rel="stylesheet" type="text/css" href="style.css">     
<script>

window.onerror = function(msg, url, line, col, error) {
   //as we do not run in a browser, we need to catch javascript errors without using F12 devtools
   //this will catch and alert all js errors on this page
   var extra = !col ? '' : '\ncolumn: ' + col;
   extra += !error ? '' : '\nerror: ' + error;
   alert("Error: " + msg + "\nurl: " + url + "\nline: " + line + extra);
   var suppressErrorAlert = true;
   return suppressErrorAlert;
};

function ffas_init(base64_displayname){    
/*
    this function is called from ffastrans when your body is loaded. You cannot force this from your code!
    you can use this as a replacement for $document.ready or body.onload
*/
}

function setSelectBoxByText(eid, etxt) {
	var eid = document.getElementById(eid);
    for (var i = 0; i < eid.options.length; ++i) {	
        if (eid.options[i].text === etxt)
            eid.options[i].selected = true;
    }
}

function ffas_load_preset(base64_string){
    /*
        this is called by ffastrans when values from preset should be displayed on this page. You cannot force this from your code!
        the object you get here is the same that you returned in the save function
        IT IS MANDATORY to display values from preset on your userinterface
    */
    if (atob(base64_string) == "{}"){
		return; //nothing to restore
	}
    try{
        //convert value from ffastrans to json object (base64 decode!)
        var obj = JSON.parse(atob(base64_string));
        if(!obj.hasOwnProperty('inputs') ){
            check_valid_variable_name()
            return; //nothing to restore
        }
        //loop through inputs array, locate dom elements by id and set value
        

        for (i=0;i<obj["inputs"].length;i++){
            var in_id = obj["inputs"][i]["id"];
            var in_value = obj["inputs"][i]["value"];
            if (document.getElementById(in_id).type === "checkbox"){    //checkboxes need other restore than text fields
                document.getElementById(in_id).checked = in_value;
            }else{
                document.getElementById(in_id).value = in_value;    //text field 
				try{
					setSelectBoxByText(in_id,in_value);	//select option
				}catch(ex){
					
				}
            }       

        }    
        
        //restore full innerHTML of singlefilecontainer
        for (i=0;i<obj["outputs"].length;i++){
            var out_id = obj["outputs"][i]["id"];
            var out_value = obj["outputs"][i]["value"];
            if (out_id == "singlefilecontainer_innerHTML"){
                document.getElementById("singlefilecontainer").innerHTML = out_value;
            }
        }
        //loop through outputs array ...
        for (i=0;i<obj["outputs"].length;i++){
            var out_id = obj["outputs"][i]["id"];
            var out_value = obj["outputs"][i]["value"];
            if (document.getElementById(out_id)){
                document.getElementById(out_id).value = out_value; 	//text field
				try{
					setSelectBoxByText(out_id,out_value); //select option
				}catch(ex){
					
				}
            }
        }                
    }catch(e){
        alert("Restore failed. "+ "Message:"+ e + "\n\nData: " + atob(base64_string) + "\n" );
        return;
    }    

}

function ffas_save_preset(){
    /*
        this is called by ffastrans when a user hits the preset save button. You cannot force this from your code! 
        IT IS MANDATORY to collect all values that can be saved and return them as base64 string here (use btoa function to encode to base64)
        tipp: simple html forms can be saved and restored using body.innerHTML
    */

    //the object to hand over to ffastrans must look like this {"inputs":[{"id":"html_element_id","value":"html_value"}],"outputs":[{"id":"html_element_id","value":"html_value","content":"default_value"}]}
    var to_save = {"inputs":[],"outputs":[]};
    
    
//INPUTS
    var inputs = document.getElementsByName("input");
	for (i=0;i<inputs.length;i++){
        if (inputs[i].disabled){
            to_save["inputs"].push({"id":inputs[i].id, "value":""});    //disabled fields will have empty value
        }
        else if (inputs[i].type==="checkbox"){
            to_save["inputs"].push({"id":inputs[i].id, "value":inputs[i].checked});
        }else if (inputs[i].type==="text"){
            to_save["inputs"].push({"id":inputs[i].id, "value":inputs[i].value});
        }else if(inputs[i].type==="select-one"){
			to_save["inputs"].push({"id":inputs[i].id, "value":inputs[i].options[inputs[i].selectedIndex].value});
		}
		
        console.log(inputs[i].id,inputs[i].value)
	}
//OUTPUTS
    var outputs = document.getElementsByName("output");
	for (i=0;i<outputs.length;i++){
		to_save["outputs"].push({"id":outputs[i].id, "value":outputs[i].value, "data":""});//for outputs, "value" can only be a variable like %s_source% and data is set by processor
	}
    //save full innerHTML of singlefilecontainer for easy restore
    to_save["outputs"].push({"id":"singlefilecontainer_innerHTML", "value":document.getElementById("singlefilecontainer").innerHTML, "data":""});
    
    return(btoa(JSON.stringify(to_save)))
}


//
// Heper functions
//

function check_valid_variable_name(dom_element){
    //this just checks if we have a valid variable on a custom textbox that defines a processor output
    var content = dom_element.value;
    dom_element.style.color = "red";
    if ((content.match(/%/g))){
        if ((content.match(/%/g)).length == 2){
            dom_element.style.color = "";
        }
    }   
}

function validate_timespan(){
    if (document.getElementById("timespan").value === "custom"){
        document.getElementById("timespan_custom").disabled=false;
    }else{
        document.getElementById("timespan_custom").disabled=true;
    }
}

function open_variables(input){
    //find input field to the left and place cursor there
    alert();if (document.activeElement == this.previousSibling){return;}this.previousSibling.focus();
    
}

function addsinglefile(){
    console.log("cloning..")
    var all_inputs = document.getElementById("singlefilecontainer").getElementsByTagName("div");
    var last_el = all_inputs[all_inputs.length - 1];
    console.log("Currently we have " +all_inputs.length + " Nodes")
    var newNode = last_el.cloneNode(true);
    console.log(newNode);
    var newInnerHTML = newNode.innerHTML.replace(/File \d+/, "File " + (all_inputs.length+1));
    newInnerHTML = newInnerHTML.replace(/output_files_\d+/g, "output_files_" + (all_inputs.length+1));
    newNode.innerHTML = newInnerHTML;
    document.getElementById("singlefilecontainer").appendChild(newNode);
}

function removesinglefile(){
    var all_inputs = document.getElementById("singlefilecontainer").getElementsByTagName("div");
    if (all_inputs.length > 1){
        var last_el = all_inputs[all_inputs.length - 1];
        document.getElementById("singlefilecontainer").removeChild(last_el);
    }
}

function ffas_folder_selected(base64_path,parent_id){
    parent_id = atob(parent_id);
    if (atob(base64_path) == ""){
		return; //nothing to restore
	}
    
    document.getElementById(parent_id).value = atob(base64_path);
    
}

</script>
</head>
<body>
    <div id="title"></div>
    <div id="restorepoint">
    <span style="width:120px;display:inline-block" >Path: </span><input style="width:380px" name="input" id="path" placeholder="" value="" ></input><input width="2px" type="submit" value="<" name="open_vars" data-parent="path"/><input name="open_folderbrowser" type="submit" value="..." data-parent="path"/>
	<div style="height:5px;visibility:hidden;"></div>
	
	<span style="width:120px;display:inline-block" >Include Patterns: </span><input style="width:380px" name="input" placeholder="" id="include" value="" ></input><input width="2px" type="submit" value="<" name="open_vars" data-parent="include"/><br/>
	<div style="height:5px;visibility:hidden;"></div>
	
	<span style="width:120px;display:inline-block" >Exclude Patterns: </span><input style="width:380px" name="input" id="exclude" placeholder="" value="" ></input><input width="2px" type="submit" value="<" name="open_vars" data-parent="exclude"/><br/>
	<div style="height:5px;visibility:hidden;"></div>
	
    <span style="width:120px;display:inline-block" >Older Than: </span><select name="input" id="timespan" onchange="validate_timespan()"><option value="0">Any Age</option><option value="60">1 Minute</option><option value="300">5 Minutes</option><option value="1800">30 Minutes</option><option value="3600">1 Hour</option><option value="86400">1 Day</option><option value="172800">2 Days</option><option value="259200">3 Days</option><option value="345600">4 Days</option><option value="432000">5 Days</option><option value="518400">5 Days</option><option value="604800">6 Days</option><option value="691200">7 Days</option><option value="custom">Custom</option></select>
    <input name="input" type="text" id="timespan_custom" disabled="true" placeholder="Custom value in hours"/><br/>
    <div style="height:5px;visibility:hidden;"></div>
    
	<span style="width:120px;display:inline-block" >Recurse: </span><input type="checkbox" name="input" id="recurse" />  
	<div style="height:5px;visibility:hidden;"></div>

	<span style="width:120px;display:inline-block" >Skip Folders: </span><input type="checkbox" name="input" id="skip_folders" />  
	<div style="height:5px;visibility:hidden;"></div>

	<span style="width:120px;display:inline-block" >Skip Files: </span><input type="checkbox" name="input" id="skip_files" />  
	<div style="height:5px;visibility:hidden;"></div>

	<span style="width:120px;display:inline-block" >Skip Size: </span><select name="input" id="skip_size_operator"><option value="=">equal</option><option value="<">less than</option><option value=">">greater than</option><option value="<=">less than or equal</option><option value=">=">greater than or equal</option><input type="text" name="input" id="skip_size" />kB
	<div style="height:5px;visibility:hidden;"></div>
	
	<span style="width:120px;display:inline-block" >Sort Order: </span><select name="input" id="sort_order" ><option>Date Created Descending</option><option>Date Created Ascending</option><option>Name Ascending</option><option>Name Descending</option></select> 
	<div style="height:5px;visibility:hidden;"></div>
	
	<span style="width:120px;display:inline-block" >Output Type: </span><select name="input" title="Output Type" id="output_type" value="json" ><option id="json">json</option><option id="ffconcat">ffconcat</option></select>
	<div style="height:5px;visibility:hidden;"></div>
	
	<!--<span style="width:120px;display:inline-block" >Wait for File Count:</span> <input style="width:50px" name="input" placeholder="2" id="wait_count" value="" title="Wait for this number of files to be found (e.g. 2 .wav files or 1 .xml file)"></input>  Max wait duration <input name="input" id="wait_duration" title="How many minutes to wait for the count of files to be found"/> 
	-->
	<div style="height:5px;visibility:hidden;"></div>
	<div style="width:100%;border-top:1px solid lightgrey"></div>

	<p style="color:#777777">Outputs</p>
	<span style="width:120px;display:inline-block" title="Variable will be populated with an array of all found files, use array function to select one file from it">File Variable:</span><input name="output" title="Select user_variable where the JSON Array of found files shall be stored in" id="output_found_array" value="" oninput="check_valid_variable_name(this)" ></input><input width="2px" type="submit" value="<" name="open_vars" data-parent="output_found_array"/><br/>
	<div style="height:5px;visibility:hidden;"></div>
	<span style="width:120px;display:inline-block" title="The count of found files">Count Variable: </span><input name="output" title="Select user_variable where the count of found files shall be stored in" id="output_found_count" value="" oninput="check_valid_variable_name(this)" ></input><input width="2px" type="submit" value="<" name="open_vars" data-parent="output_found_count" /><br/>
    <div style="height:5px;visibility:hidden;"></div>
    <p style="color:#777777;display:inline-block" title="Variables will be populated with a single file from the list" >Single File Outputs: <input  type="submit" onclick="addsinglefile()" id="addsinglefile" value="+" /><input onclick="removesinglefile()" type="submit" id="removesinglefile" value="-" /></p>
    <div style="height:5px;visibility:hidden;"></div>
    <div id="singlefilecontainer">
        <div><span style="width:120px;display:inline-block" >File 1</span><input name="output" title="File Number X" id="output_files_1" value="" oninput="check_valid_variable_name(this)" ></input><input width="2px" type="submit" value="<" name="open_vars" data-parent="output_files_1" data-user_vars_only="true"/><br/></div>
    </div>
    </div>
</body>
